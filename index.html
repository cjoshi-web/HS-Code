<!DOCTYPE html>
<html>
<head>
    <title>Display Google Sheet Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 0;
        }
        .container-fluid {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #search-input {
            margin-bottom: 2rem;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #ccc;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            font-size: 1.1rem;
            width: 400px;
            max-width: 90%;
            transition: all 0.3s ease;
        }
        #search-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        .table-container {
            border-radius: 1rem;
            background-color: #fff;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            width: 95%;
            max-width: 1200px;
            margin-bottom: 2rem;
            position: relative;
            overflow-y: auto;
            max-height: 500px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            position: relative;
        }
        .table thead th {
            padding: 1.2rem;
            text-align: center;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
            color: #333;
            background-color: #f8f8f8;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
            position: sticky;
            top: 0;
            z-index: 10;
            width: fit-content;
            white-space: nowrap;
        }
        .table thead th:hover {
            background-color: #f0f0f0;
        }
        .table tbody tr {
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
        }
        .table tbody tr:hover {
            background-color: #f5f5f5;
            transform: translateY(-4px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.08);
        }
        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
            color: #444;
            width: fit-content;
            white-space: nowrap;
            text-align: center;
        }
        .table tbody tr:last-child td {
            border-bottom: none;
        }
        .table tbody tr.selected {
            background-color: #e0f7fa !important;
            transform: translateY(-4px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.08);
        }
        .share-button {
            background-color: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
        .share-button:hover {
            background-color: #45a049;
        }
        #canvas {
            display: none;
        }
        @media (max-width: 768px) {
            .table-container {
                width: 100%;
                margin-left: 0;
                margin-right: 0;
                border-radius: 0;
                box-shadow: none;
            }
            #search-input {
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .container-fluid{
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <input type="text" id="search-input" class="form-control" placeholder="Search by First Column...">
        <div class="table-container">
            <table id="data-table" class="table table-hover">
                <thead>
                    <tr></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <canvas id="canvas"></canvas>
    </div>
    <script>
        // Source: https://stackoverflow.com/a/53218732
        function urlToKey(url) {
            const match = url.match(/[-\w]{25,}/);
            return match ? match[0] : null;
        }

        function loadSheet() {
            const sheetUrl = "https://docs.google.com/spreadsheets/d/1e7gJyAZbJIRqDh83Wn6oiz0SMZstT-Nr/edit?usp=drive_link&ouid=104756939868141529459&rtpof=true&sd=true";
            const sheetId = urlToKey(sheetUrl);
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

            fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                    const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                    const table = document.getElementById("data-table");
                    let headerRow = table.querySelector("thead tr");
                    let dataBody = table.querySelector("tbody");
                    headerRow.innerHTML = '';
                    dataBody.innerHTML = '';

                    if (!jsonData.table || !jsonData.table.rows) {
                        table.innerHTML = '<b>Error: No data found in the Google Sheet.  Please check the URL and ensure the sheet is published.</b>';
                        return;
                    }

                    const headers = jsonData.table.cols.map(col => col.label);
                    headers.unshift('Share');

                    headers.forEach((header, index) => {
                        let th = document.createElement("th");
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });

                    let rawData = [];
                    jsonData.table.rows.forEach(row => {
                        let tr = document.createElement("tr");
                        const shareButtonCell = document.createElement("td");
                        const shareButton = document.createElement("button");
                        shareButton.className = "share-button";
                        shareButton.textContent = "Share";
                        shareButton.addEventListener('click', function(event) {
                            // Find the  values in the row.
                            const rowData = Array.from(this.parentNode.parentNode.querySelectorAll('td'));
                            let hsCodeValue = '';
                            let cooValue = '';
                            let name1Value = '';
                            let value1Value = '';
                            let name22Value = '';
                            let value2Value = '';

                            if (rowData && rowData.length > 2) {
                                 hsCodeValue = rowData[2].textContent;
                            }
                            if (rowData && rowData.length > 3) {
                                 cooValue = rowData[3].textContent;
                            }
                             if (rowData && rowData.length > 8) {
                                 name1Value = rowData[8].textContent;
                            }
                            if (rowData && rowData.length > 9) {
                                 value1Value = rowData[9].textContent;
                            }
                             if (rowData && rowData.length > 10) {
                                 name22Value = rowData[10].textContent;
                            }
                            if (rowData && rowData.length > 11) {
                                 value2Value = rowData[11].textContent;
                            }
                            const combinedValue = `${hsCodeValue} -- ${cooValue} // ${name1Value} ** ${value1Value} // ${name22Value} ** ${value2Value}`;
                            if (combinedValue) {
                                convertTextToImage(combinedValue, event.target);
                            } else {
                                alert(' values not found!');
                            }
                        });
                        shareButtonCell.appendChild(shareButton);
                        tr.appendChild(shareButtonCell);

                        let rowData = [];
                        rowData.push(shareButtonCell);
                        row.c.forEach((cell, index) => {
                            let cellValue = (cell && cell.v != null) ? cell.v : '';
                            rowData.push(cellValue);
                        });

                        row.c.forEach((cell, index) => {
                            let cellValue = (cell && cell.v != null) ? cell.v : '';
                            let td = document.createElement("td");
                            td.textContent = cellValue;
                            tr.appendChild(td);
                        });
                        tr.addEventListener('click', function() {
                            const selectedRow = document.querySelector('.table tbody tr.selected');
                            if (selectedRow) {
                                selectedRow.classList.remove('selected');
                            }
                            this.classList.add('selected');
                        });
                        dataBody.appendChild(tr);
                        rawData.push(rowData);
                    });

                    const searchInput = document.getElementById("search-input");

                    searchInput.addEventListener("input", function () {
                        const searchTerm = this.value.toLowerCase();
                        dataBody.innerHTML = '';

                        rawData.forEach(row => {
                            let displayRow = true;
                            for (let i = 1; i < row.length; i++) {
                                let cellValue = row[i];
                                if (typeof cellValue === 'object' && cellValue instanceof Node) {
                                     continue;
                                }
                                if (cellValue && String(cellValue).toLowerCase().includes(searchTerm)) {
                                    displayRow = true;
                                    break;
                                } else {
                                    displayRow = false;
                                }
                            }

                            if (displayRow) {
                                let tr = document.createElement("tr");
                                const shareButtonCell = document.createElement("td");
                                const shareButton = document.createElement("button");
                                shareButton.className = "share-button";
                                shareButton.textContent = "Share";
                                 shareButton.addEventListener('click', function(event) {
                                      const rowData = Array.from(this.parentNode.parentNode.querySelectorAll('td'));
                                     let hsCodeValue = '';
                                     let cooValue = '';
                                     let name1Value = '';
                                     let value1Value = '';
                                     let name22Value = '';
                                     let value2Value = '';

                                     if (rowData && rowData.length > 2) {
                                          hsCodeValue = rowData[2].textContent;
                                     }
                                     if (rowData && rowData.length > 3) {
                                          cooValue = rowData[3].textContent;
                                     }
                                      if (rowData && rowData.length > 8) {
                                          name1Value = rowData[8].textContent;
                                     }
                                     if (rowData && rowData.length > 9) {
                                          value1Value = row[9].textContent;
                                     }
                                      if (rowData && rowData.length > 10) {
                                          name22Value = rowData[10].textContent;
                                     }
                                     if (rowData && rowData.length > 11) {
                                          value2Value = row[11].textContent;
                                     }
                                     const combinedValue = `${hsCodeValue} -- ${cooValue} // ${name1Value} ** ${value1Value} // ${name22Value} ** ${value2Value}`;

                                     if (combinedValue) {
                                         convertTextToImage(combinedValue, event.target);
                                     }
                                     else{
                                          alert(' values not found!');
                                     }
                                 });
                                shareButtonCell.appendChild(shareButton);
                                tr.appendChild(shareButtonCell);
                                tr.addEventListener('click', function() {
                                    const selectedRow = document.querySelector('.table tbody tr.selected');
                                    if (selectedRow) {
                                        selectedRow.classList.remove('selected');
                                    }
                                    this.classList.add('selected');
                                });
                                for (let i = 1; i < row.length; i++) {
                                    let cellValue = row[i];
                                    let td = document.createElement("td");
                                    if (typeof cellValue === 'object' && cellValue instanceof Node) {
                                         td.appendChild(cellValue)
                                    }
                                    else{
                                         td.textContent = cellValue;
                                     }

                                    tr.appendChild(td);
                                }
                                dataBody.appendChild(tr);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error("Error fetching or parsing data:", error);
                    const table = document.getElementById("data-table");
                    table.innerHTML = `<b>Error: Could not retrieve data from the Google Sheet.  Please check the URL and your internet connection. Error Details: ${error}</b>`;
                });
        }

        function convertTextToImage(text, clickedButton) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // Set the dimensions of the canvas
            canvas.width = 600;
            canvas.height = 200;

            // Background
            ctx.fillStyle = '#f8f8f8'; // Light background
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Text styling
            ctx.font = 'bold 24px Inter'; // Increased font size and bold
            ctx.fillStyle = '#2c3e50'; // Darker text color for better contrast
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)'; // Refined shadow
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;

            // Split the text into lines
            const lines = text.split('//');
            const lineHeight = 36;  // Adjust as needed for line spacing, increased to match font size
            const startY = canvas.height / 2 - (lines.length - 1) * lineHeight / 2; // Center Vertically

            // Print each line of the text on the canvas
            lines.forEach((line, index) => {
                const trimmedLine = line.trim();
                ctx.fillText(trimmedLine, canvas.width / 2, startY + index * lineHeight);
            });

            // Convert the canvas to a data URL
            const dataURL = canvas.toDataURL('image/jpeg', 0.95); // 0.95 for very high quality

            // Open the image in a new tab
            const img = new Image();
            img.src = dataURL;
            const newTab = window.open();
            newTab.document.body.appendChild(img);

            clickedButton.textContent = 'Opened!';
            setTimeout(() => {
                clickedButton.textContent = 'Share';
            }, 2000);
        }

        window.onload = loadSheet;
    </script>
</body>
</html>
